{% extends "base/base.html" %}

{% load static checklist_tags %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="m-0">{{ user.user_type|title }} Task</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            
            <div class="card card-row card-secondary">
                <div class="card-header">
                    <h3 class="card-title">
                        Todo
                    </h3>
                </div>
                <div class="card-body">
                    {% for open_task in open_tasks %}
                    <div class="card {{ open_task.get_priority_color }} card-outline task-card" draggable="true" data-task-id="{{ open_task.id }}">
                        <div class="card-header">
                            <h5 class="card-title">{{ open_task.title }}</h5>
                            <div class="card-tools">
                                <a href="#" class="btn btn-tool btn-link">#{{ open_task.ticket_id }}</a>
                                <a href="#" class="btn btn-tool" data-bs-toggle="modal" data-bs-target="#taskDetails{{ open_task.id }}">
                                    <i class="fas fa-pen"></i>
                                </a>
                                <!-- Modal -->
                                <div class="modal fade" id="taskDetails{{ open_task.id }}" tabindex="-1" aria-labelledby="taskDetails{{ open_task.id }}Label" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button class="btn btn-primary btn-sm">Move to Inprogress</button>
                                        </div>
                                        <div class="modal-body">
                                            <ul class="nav nav-tabs" id="myTab" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link active" id="home{{ open_task.ticket_id }}-tab" data-bs-toggle="tab" data-bs-target="#home{{ open_task.ticket_id }}" type="button" role="tab" aria-controls="home{{ open_task.ticket_id }}" aria-selected="true">Task Details</button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="profile{{ open_task.ticket_id }}-tab" data-bs-toggle="tab" data-bs-target="#profile{{ open_task.ticket_id }}" type="button" role="tab" aria-controls="profile{{ open_task.ticket_id }}" aria-selected="false">Task Update</button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">Media</button>
                                                </li>
                                            </ul>
                                            <div class="tab-content" id="myTabContent">
                                                <div class="tab-pane fade show active" id="home{{ open_task.ticket_id }}" role="tabpanel" aria-labelledby="home{{ open_task.ticket_id }}-tab">
                                                    <div class="card mt-4">
                                                        <div class="card-body">
                                                            <p><strong>Task ID:</strong> {{ open_task.ticket_id }}</p>
                                                            <p><strong>Due Date:</strong> {{ open_task.due_date }}</p>
                                                            <p><strong>Priority:</strong> {{ open_task.priority|title }}</p>
                                                            <p><strong>Affected People:</strong> {{ open_task.affected_people }}</p>
                                                            <p><strong>Status:</strong>
                                                                {% if open_task.status == 'open' %}
                                                                <span class="badge badge-success">Todo</span>
                                                                {% elif open_task.status == 'in_progress' %}
                                                                <span class="badge badge-primary">In Progress</span>
                                                                {% elif open_task.info == 'closed' %}
                                                                <span class="badge badge-success">Done</span>
                                                                {% else %}
                                                                <span class="badge badge-secondary">Unknown</span>
                                                                {% endif %}
                                                            </p>
                                                            <p><strong>Tag:</strong> {% for tag in open_task.tags.all %} <span class="badge badge-info">{{ tag }}</span>{% endfor %}</p>
                                                            <p><strong>Description:</strong> {{ open_task.description|render_checklist:open_task.id|safe }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="tab-pane fade" id="profile{{ open_task.ticket_id }}" role="tabpanel" aria-labelledby="profile{{ open_task.ticket_id }}-tab">
                                                    <div class="card mt-4">
                                                        <div class="card-body">
                                                            <div class="form-group">
                                                                <label><strong>Task ID:</strong> {{ open_task.ticket_id }}</label>
                                                            </div>
                                                            <form method="post" action="{% url 'task:task_update' open_task.pk %}">
                                                                {% csrf_token %}
                                                                <div class="row">
                                                                    <div class="col-md-6">
                                                                        <div class="form-group">
                                                                            <label for="due_date"><strong>Title:</strong></label>
                                                                            <input type="text" class="form-control" id="task_title" name="title" 
                                                                                value="{{ open_task.title }}">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <div class="form-group">
                                                                            <label for="due_date"><strong>Due Date:</strong></label>
                                                                            <input type="datetime-local" class="form-control" id="due_date" name="due_date" 
                                                                                value="{{ open_task.due_date|date:'Y-m-d\TH:i' }}">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <div class="form-group">
                                                                            <label for="priority"><strong>Priority:</strong></label>
                                                                            <select class="form-control" id="priority" name="priority">
                                                                                <option value="low" {% if open_task.priority == 'low' %}selected{% endif %}>Low</option>
                                                                                <option value="medium" {% if open_task.priority == 'medium' %}selected{% endif %}>Medium</option>
                                                                                <option value="high" {% if open_task.priority == 'high' %}selected{% endif %}>High</option>
                                                                                <option value="critical" {% if open_task.priority == 'critical' %}selected{% endif %}>Critical</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <div class="form-group">
                                                                            <label><strong>Tags:</strong></label>
                                                                            <div class="d-flex flex-wrap mb-2">
                                                                                {% for tag in open_task.tags.all %}
                                                                                    <span class="badge badge-info mr-2 mb-2">{{ tag }}</span>
                                                                                {% endfor %}
                                                                            </div>
                                                                            <select class="form-control select2-multiple" id="tags" name="tags" multiple>
                                                                                {% for tag in all_tags %}
                                                                                    <option value="{{ tag.id }}" {% if tag in open_task.tags.all %}selected{% endif %}>
                                                                                        {{ tag.name }}
                                                                                    </option>
                                                                                {% endfor %}
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <!-- Description -->
                                                                <div class="form-group">
                                                                    <label for="description"><strong>Description:</strong></label>
                                                                    <textarea class="form-control description" id="description" name="description">
                                                                        {{ open_task.description|safe }}
                                                                    </textarea>
                                                                </div>
                                                                
                                                                <button type="submit" class="btn btn-primary">Update Task</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                                                    media
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                    </div>
                                </div>    

                            </div>
                        </div>
                        <div class="card-body">
                            {% if open_task.due_date %}
                            <p>
                                <strong>Due date:</strong> {{ open_task.due_date }}
                            </p>
                            {% endif %}
                            {{ open_task.description|render_checklist:open_task.id|safe }}
                        </div>
                    </div>
                     
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-row card-primary" id="inProgressColumn">
                <div class="card-header">
                    <h3 class="card-title">In Progress</h3>
                </div>
                <div class="card-body" id="inProgressTasks">
                    <!-- This is where dropped tasks will go -->
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-row card-default">
                <div class="card-header bg-info">
                    <h3 class="card-title">
                        Done
                    </h3>
                </div>
                
            </div>
        </div>
    </div>
    <!-- Bootstrap JS Bundle with Popper -->
<!-- jQuery (required) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Font Awesome (for icons) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Initialize Summernote -->
<script>
$(document).ready(function() {
    $('.description').summernote({
        height: 300,
        toolbar: [
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['para', ['ul', 'ol', 'paragraph', 'checklist']], // Checklist button
            ['insert', ['link', 'picture', 'video']],
            ['view', ['fullscreen', 'codeview', 'help']]
        ],

        buttons: {
            checklist: function(context) {
                return $.summernote.ui.button({
                    contents: '<i class="fas fa-tasks"></i>',
                    tooltip: 'Checklist',
                    click: function() {
                        context.invoke('editor.insertText', '- [ ] ');
                    }
                }).render();
            }
        }
    });
});


document.addEventListener('DOMContentLoaded', function() {
    const checklistItems = document.querySelectorAll('.checklist-item');
    const taskId = 1;  // Make sure to pass task.id to template

    checklistItems.forEach(checkbox => {
        // Set initial state
        const textElement = checkbox.querySelector('span');
        const checkboxInput = checkbox.querySelector('input');
        
        if (checkboxInput.checked) {
            textElement.style.textDecoration = 'line-through';
            textElement.style.color = '#6c757d';
        }
        console.log(checkboxInput.value)
        const taskId = checkboxInput.value;
        // Add toggle handler with AJAX
        checkboxInput.addEventListener('change', function() {
            const text = textElement.textContent.trim();
            
            // Optimistic UI update
            if (this.checked) {
                textElement.style.textDecoration = 'line-through';
                textElement.style.color = '#6c757d';
            } else {
                textElement.style.textDecoration = 'none';
                textElement.style.color = 'inherit';
            }
            
            // AJAX call to save state
            fetch(`/task/${taskId}/update_checklist/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    checklist_items: [{
                        text: text,
                        checked: this.checked
                    }]
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    // Revert if failed
                    checkboxInput.checked = !checkboxInput.checked;
                    if (checkboxInput.checked) {
                        textElement.style.textDecoration = 'none';
                        textElement.style.color = 'inherit';
                    } else {
                        textElement.style.textDecoration = 'line-through';
                        textElement.style.color = '#6c757d';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert on error
                checkboxInput.checked = !checkboxInput.checked;
            });
        });
    });
});

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set up drag events for all task cards
    const cards = document.querySelectorAll('.task-card');
    cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
    });

    // Set up drop zones (columns)
    const columns = document.querySelectorAll('.card-body');
    columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
        column.addEventListener('dragenter', handleDragEnter);
        column.addEventListener('dragleave', handleDragLeave);
    });

    let draggedCard = null;

    function handleDragStart(e) {
        draggedCard = e.target;
        e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
        e.target.classList.add('dragging');
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    function handleDrop(e) {
        e.preventDefault();
        if (!draggedCard) return;

        // Get the task ID from the dragged card
        const taskId = e.dataTransfer.getData('text/plain');
        // Determine the target column (status)
        const targetColumn = e.currentTarget.closest('.card-row');
        let newStatus = 'open'; // default
        
        if (targetColumn.classList.contains('card-primary')) {
            newStatus = 'in_progress';
        } else if (targetColumn.classList.contains('card-secondary')) {
            newStatus = 'open';
        } else if (targetColumn.classList.contains('card-success')) {
            newStatus = 'closed';
        }

        // Move the card visually
        e.currentTarget.appendChild(draggedCard);
        draggedCard.classList.remove('dragging');

        // Update the status on the server
        updateTaskStatus(taskId, newStatus);
    }

    function handleDragEnter(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
    }

    function updateTaskStatus(taskId, newStatus) {
        alert(newStatus)
        fetch(`/task/tasks/${taskId}/${newStatus}/update_status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to update task status');
                // Optionally revert the UI change
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
});
</script>
{% endblock %}