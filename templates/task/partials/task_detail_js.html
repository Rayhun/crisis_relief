<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Summernote
    $('.description').summernote({
        height: 300,
        toolbar: [
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['para', ['ul', 'ol', 'paragraph', 'checklist']],
            ['insert', ['link', 'picture', 'video']],
            ['view', ['fullscreen', 'codeview', 'help']]
        ],
        buttons: {
            checklist: function(context) {
                return $.summernote.ui.button({
                    contents: '<i class="fas fa-tasks"></i>',
                    tooltip: 'Checklist',
                    click: function() {
                        context.invoke('editor.insertText', '- [ ] ');
                    }
                }).render();
            }
        }
    });

    // Move to next status button
    $('.move-to-next').click(function() {
        const taskId = $(this).data('task-id');
        const currentStatus = $(this).data('current-status');
        let newStatus = 'open';
        
        if (currentStatus === 'open') newStatus = 'in_progress';
        else if (currentStatus === 'in_progress') newStatus = 'closed';
        else if (currentStatus === 'closed') newStatus = 'open';
        
        updateTaskStatus(taskId, newStatus);
    });

    // Initialize Select2 for tags
    $('.select2-multiple').select2({
        theme: 'bootstrap4',
        width: '100%'
    });
});

function updateTaskStatus(taskId, newStatus) {
    $.ajax({
        url: `/task/tasks/${taskId}/${newStatus}/update_status/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        success: function(data) {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Failed to update task status');
            }
        },
        error: function(error) {
            console.error('Error:', error);
            alert('An error occurred while updating the task status');
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>