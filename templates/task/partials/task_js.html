<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Summernote
    $('.description').summernote({
        height: 300,
        toolbar: [
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['para', ['ul', 'ol', 'paragraph', 'checklist']],
            ['insert', ['link', 'picture', 'video']],
            ['view', ['fullscreen', 'codeview', 'help']]
        ],
        buttons: {
            checklist: function(context) {
                return $.summernote.ui.button({
                    contents: '<i class="fas fa-tasks"></i>',
                    tooltip: 'Checklist',
                    click: function() {
                        context.invoke('editor.insertText', '- [ ] ');
                    }
                }).render();
            }
        }
    });

    // Drag and Drop functionality
    setupDragAndDrop();
    
    // Checklist functionality
    setupChecklist();
    
    // Move to next status button
    $('.move-to-next').click(function() {
        const taskId = $(this).data('task-id');
        const currentStatus = $(this).data('current-status');
        let newStatus = 'open';
        
        if (currentStatus === 'open') newStatus = 'in_progress';
        else if (currentStatus === 'in_progress') newStatus = 'closed';
        else if (currentStatus === 'closed') newStatus = 'open';
        
        updateTaskStatus(taskId, newStatus);
    });
});

function setupDragAndDrop() {
    let draggedCard = null;

    $('.task-card').on('dragstart', function(e) {
        draggedCard = this;
        e.originalEvent.dataTransfer.setData('text/plain', $(this).data('task-id'));
        $(this).addClass('dragging');
    });

    $('.card-body').on('dragover', function(e) {
        e.preventDefault();
        e.originalEvent.dataTransfer.dropEffect = 'move';
    }).on('drop', function(e) {
        e.preventDefault();
        if (!draggedCard) return;

        const taskId = e.originalEvent.dataTransfer.getData('text/plain');
        const targetColumn = $(this).closest('.card-row');
        let newStatus = 'open';
        
        if (targetColumn.hasClass('card-primary')) newStatus = 'in_progress';
        else if (targetColumn.hasClass('card-secondary')) newStatus = 'open';
        else if (targetColumn.hasClass('card-success')) newStatus = 'closed';

        $(this).append(draggedCard);
        $(draggedCard).removeClass('dragging');
        updateTaskStatus(taskId, newStatus);
        draggedCard = null;
    }).on('dragenter', function(e) {
        e.preventDefault();
        $(this).addClass('drag-over');
    }).on('dragleave', function() {
        $(this).removeClass('drag-over');
    });
}

function setupChecklist() {
    $('.checklist-item input').each(function() {
        const checkbox = $(this);
        const textElement = checkbox.siblings('span');
        
        if (checkbox.is(':checked')) {
            textElement.css({
                'text-decoration': 'line-through',
                'color': '#6c757d'
            });
        }
        
        checkbox.on('change', function() {
            const taskId = $(this).val();
            const text = textElement.text().trim();
            const isChecked = $(this).is(':checked');
            
            // Optimistic UI update
            textElement.css({
                'text-decoration': isChecked ? 'line-through' : 'none',
                'color': isChecked ? '#6c757d' : 'inherit'
            });
            
            // AJAX call
            $.ajax({
                url: `/task/${taskId}/update_checklist/`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    checklist_items: [{
                        text: text,
                        checked: isChecked
                    }]
                }),
                success: function(data) {
                    if (data.status !== 'success') {
                        checkbox.prop('checked', !isChecked);
                        textElement.css({
                            'text-decoration': isChecked ? 'none' : 'line-through',
                            'color': isChecked ? 'inherit' : '#6c757d'
                        });
                    }
                },
                error: function() {
                    checkbox.prop('checked', !isChecked);
                    textElement.css({
                        'text-decoration': isChecked ? 'none' : 'line-through',
                        'color': isChecked ? 'inherit' : '#6c757d'
                    });
                }
            });
        });
    });
}

function updateTaskStatus(taskId, newStatus) {
    $.ajax({
        url: `/task/tasks/${taskId}/${newStatus}/update_status/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(data) {
            if (!data.success) {
                console.error('Failed to update task status');
                // Optionally revert the UI change
            }
        },
        error: function(error) {
            console.error('Error:', error);
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>