{% extends "base/base.html" %}

{% load static crispy_forms_tags %}

{% block head %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #suggestions {
            background: #fff;
            position: absolute;
            z-index: 1000;
        }
        #suggestions li {
            padding: 8px;
            cursor: pointer;
        }
        #suggestions li:hover {
            background-color: #f0f0f0;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12 card">
            <div class="card-header">
                <h4>Donate Goods</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <ul id="suggestions"></ul>
                    <button type="submit" class="btn btn-sm btn-success">Donate</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
      let typingTimer;
      const delay = 300; // milliseconds

      $("#id_pickup_address").on("input", function () {
        clearTimeout(typingTimer);
        const query = $(this).val();

        if (query.length > 2) {
          typingTimer = setTimeout(function () {
            $.get("https://photon.komoot.io/api/", { q: query, limit: 10 })
              .done(function (data) {
                const suggestions = data.features.map(function (feature) {
                  const props = feature.properties;
                  return `${props.name || ""}, ${props.city || props.state || ""}, ${props.country || ""}`;
                });

                const $list = $("#suggestions").empty();
                suggestions.forEach(function (s) {
                  $("<li>").text(s).appendTo($list).click(function () {
                    $("#id_pickup_address").val(s);
                    $list.empty();
                  });
                });
              });
          }, delay);
        } else {
          $("#suggestions").empty();
        }
      });

      // Optional: Hide suggestions if clicked outside
      $(document).on("click", function (e) {
        if (!$(e.target).closest("#address-input, #suggestions").length) {
          $("#suggestions").empty();
        }
      });
    });
  </script>
{% endblock %}