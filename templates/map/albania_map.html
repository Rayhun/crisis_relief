{% extends "base/base.html" %}
{% load static %}

{% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            width: 100%;
            height: 750px;
            background: #f8f9fa;
            border-radius: 4px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Albania Crisis Map</h3>
                </div>
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>
        </div>
        {% if request.user.is_superuser %}
        <!-- Bootstrap Modal -->
      <div class="modal fade" id="latLngModal" tabindex="-1" role="dialog" aria-labelledby="latLngModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <form id="eventForm" action="{% url 'affected:map_event_create' %}" method="POST">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="latLngModalLabel">Add Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="latitude" class="form-label">Latitude</label>
                      <input type="text" class="form-control" id="latitude" name="latitude" readonly>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="longitude" class="form-label">Longitude</label>
                      <input type="text" class="form-control" id="longitude" name="longitude" readonly>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="event_type" class="form-label">Event Type</label>
                      <select class="form-select form-control" id="event_type" name="event_type">
                        <option value="flood">Flood</option>
                        <option value="fire">Fire</option>
                        <option value="earthquake">Earthquake</option>
                        <option value="pandemic">Pandemic</option>
                        <!-- Add other options from EVENT_TYPE_CHOICES -->
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="title" class="form-label">Title <b>*</b></label>
                      <input type="text" class="form-control" id="title" name="title" placeholder="Add Event Title" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="date" class="form-label">Date & Time</label>
                      <input type="datetime-local" class="form-control" id="date" name="date">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="location" class="form-label">Location</label>
                      <input type="text" class="form-control" id="location" name="location">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="radius" class="form-label">Radius (km)</label>
                      <input type="number" step="0.1" class="form-control" id="radius" name="radius">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="affected_people" class="form-label">Affected People</label>
                      <input type="number" class="form-control" id="affected_people" name="affected_people">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="intensity" class="form-label">Intensity</label>
                      <select class="form-select form-control" id="intensity" name="intensity">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="status" class="form-label">Status</label>
                      <select class="form-select form-control" id="status" name="status">
                        <option value="open">Open</option>
                        <option value="closed">Closed</option>
                        <!-- Add other options from STATUS_CHOICES -->
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Description -->
                <div class="mb-3">
                  <label for="description" class="form-label">Description</label>
                  <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Submit</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
      // Initialize the map centered on Albania
      var map = L.map('map').setView([41.1533, 20.1683], 7.7);
    
    // Add OpenStreetMap tiles with a grayscale filter for non-Albania areas
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        className: 'albania-focused-map'
    }).addTo(map);
    // Set Albania bounds
    var southWest = L.latLng(39.1, 18.9),
        northEast = L.latLng(42.9, 21.3);
    var bounds = L.latLngBounds(southWest, northEast);
    
    // Restrict view to Albania
    map.setMaxBounds(bounds);
    map.on('drag', function() {
        map.panInsideBounds(bounds, { animate: false });
    });

    const manualUrl = window.location.protocol + "//" + window.location.host;

    // Add Albania's precise boundary (using GeoJSON)
    var geojson = manualUrl + '/static/js/alb.geo.json'
    fetch(geojson)
        .then(response => response.json())
        .then(data => {
            // Highlight Albania with a colored border
            L.geoJSON(data, {
                style: {
                    color: '#3388ff',  // Border color
                    weight: 2,         // Border width
                    fillColor: '#3388ff', // Fill color
                    fillOpacity: 0.1   // Fill opacity
                }
            }).addTo(map);
        });
    
        {% for event in events %}
    // Choose Font Awesome icon class based on event type
    var iconHtml = "";
    {% if event.event_type == "flood" %}
        iconHtml = '<i class="fas fa-water fa-2x"></i>';
    {% elif event.event_type == "fire" %}
        iconHtml = '<i class="fas fa-fire fa-2x"></i>';
    {% elif event.event_type == "earthquake" %}
        iconHtml = '<i class="fas fa-house-damage fa-2x"></i>';
    {% elif event.event_type == "pandemic" %}
        iconHtml = '<i class="fas fa-virus fa-2x"></i>';
    {% else %}
        iconHtml = '<i class="fas fa-exclamation-triangle fa-2x"></i>';
    {% endif %}

    // Create Leaflet Font Awesome marker
    var faIcon = L.divIcon({
        html: iconHtml,
        className: 'custom-fa-icon',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    // Add marker to map
    L.marker([{{ event.latitude }}, {{ event.longitude }}], { icon: faIcon })
        .addTo(map)
        .bindPopup(`
            <strong>{{ event.title }}</strong><br>
            Type: {{ event.event_type|title }}<br>
            Radius: {{ event.radius }} km <br>
            Affected People: {{ event.affected_people }}<br>
            Date: {{ event.date|date:"Y-m-d H:i" }}<br>
            Status: {{ event.status|title }}<br>
        `);

    // Add circle with tooltip
    L.circle([{{ event.latitude }}, {{ event.longitude }}], {
        color: "{{ event.color }}",
        fillColor: "{{ event.color }}",
        fillOpacity: 0.5,
        radius: {{ event.radius }} * 1000
    })
    .addTo(map)
    .bindTooltip(
        `<strong>{{ event.title }}</strong><br>
          Type: {{ event.event_type|title }}<br>
          Radius: {{ event.radius }} km <br>
         Affected People: {{ event.affected_people }}<br>
         Date: {{ event.date|date:"Y-m-d H:i" }}`,
        { direction: 'top', permanent: false, sticky: true }
    );
{% endfor %}

map.on('click', function(e) {
    var lat = e.latlng.lat.toFixed(5);
    var lng = e.latlng.lng.toFixed(5);

    // Set lat/lng into input fields
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;

    // Show modal immediately with loading placeholder in location
    document.getElementById('location').value = "Fetching address...";

    // Show the Bootstrap modal
    var latLngModal = new bootstrap.Modal(document.getElementById('latLngModal'));
    latLngModal.show();

    // Fetch address using reverse geocoding
    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
        .then(response => response.json())
        .then(data => {
            const address = data.display_name || "Address not found";
            document.getElementById('location').value = address;
        })
        .catch(error => {
            document.getElementById('location').value = "Address lookup failed.";
            console.error("Reverse geocoding error:", error);
        });
});
    

</script>
{% endblock %}